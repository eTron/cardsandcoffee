type: custom:button-card
entity: sensor.time
tap_action:
  action: call-service
  service: homeassistant.update_entity
  target:
    entity_id: sensor.daily_weather_forecast
triggers_update:
  - weather.home_2
  - sensor.home_humidity
  - sensor.moorpark_aqi_aqi_us_aqi
  - sensor.home_uv_index
  - sensor.daily_weather_forecast
variables:
  entity_weather: weather.home_2
  entity_humidity: sensor.home_humidity
  entity_aqi: sensor.moorpark_aqi_aqi_us_aqi
  entity_uv: sensor.home_uv_index
  entity_forecast: sensor.daily_weather_forecast
  forecast_days: 3
  forecast_icon_size: 30px
  forecast_font_size: 0.9rem
  forecast_temp_size: 0.95rem
show_name: false
show_icon: false
show_state: false
grid_options:
  columns: 6
styles:
  card:
    - border-radius: 15px
    - background-color: var(--card-background-color)
    - color: var(--primary-text-color)
    - padding: 10px 15px
    - box-shadow: var(--ha-card-box-shadow, none)
  grid:
    - grid-template-areas: |
        "time time"
        "current stats"
        "forecast forecast"
    - grid-template-columns: auto 1fr
    - grid-template-rows: auto auto auto
    - row-gap: 5px
    - column-gap: 20px
  custom_fields:
    time:
      - align-self: center
      - font-size: 2.8rem
      - font-weight: 700
      - line-height: 1
      - padding-bottom: 4px
    current:
      - align-self: center
      - justify-self: start
      - display: flex
      - align-items: center
      - gap: 5px
      - margin-left: 4px
    stats:
      - align-self: center
      - justify-self: start
      - font-size: 0.9rem
      - line-height: 1.4
      - color: var(--secondary-text-color)
      - text-align: left
    forecast:
      - margin-top: 10px
      - padding-top: 10px
      - border-top: 1px solid var(--divider-color)
custom_fields:
  time: |
    [[[ 
      var d = new Date();
      return d.toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit'}); 
    ]]]
  current: |
    [[[
      var weatherEntity = states[variables.entity_weather];
      if (!weatherEntity) return "N/A";

      var temp = weatherEntity.attributes.temperature;
      var state = weatherEntity.state;
      return `
        <img src="/local/weather-icons/${state}.svg" style="width: 45px; height: 45px;">
        <span style="font-size: 1.8rem; font-weight: 600;">${temp}°</span>
      `;
    ]]]
  stats: |
    [[[
      var hum = states[variables.entity_humidity] ? states[variables.entity_humidity].state : 'N/A';
      var aqi = states[variables.entity_aqi] ? states[variables.entity_aqi].state : 'N/A';
      var uv = states[variables.entity_uv] ? states[variables.entity_uv].state : 'N/A';
       
      return `
        <div><ha-icon icon="mdi:water-percent" style="width: 16px; color: #3498db;"></ha-icon>HUM ${hum}%</div>
        <div><ha-icon icon="mdi:leaf" style="width: 15px; color: #2ecc71;"></ha-icon> AQI ${aqi}</div>
        <div><ha-icon icon="mdi:sunglasses" style="width: 15px; color: #f1c40f;"></ha-icon> UV ${uv}</div>
      `;
    ]]]
  forecast: |
    [[[
      try {
        var forecastEntity = states[variables.entity_forecast];
        if (!forecastEntity) return "Sensor Unavailable";

        var attributes = forecastEntity.attributes || {};
        var forecast = attributes.forecast;
        var daysToShow = variables.forecast_days;
        
        var iconSize = variables.forecast_icon_size;
        var fontSize = variables.forecast_font_size;
        var tempSize = variables.forecast_temp_size;

        if (!forecast) return "Waiting for Google...";
        if (!Array.isArray(forecast)) return "Invalid Data";
        
        var html = '<div style="display: flex; justify-content: space-between; text-align: center;">';
        
        forecast.slice(0, daysToShow).forEach(day => {
            var d = new Date(day.datetime);
            var dayName = d.toLocaleDateString('en-US', {weekday: 'short'});
            var low = day.templow !== undefined ? `<span style="opacity:0.6">${day.templow}°</span>` : '';
            var iconPath = `/local/weather-icons/${day.condition}.svg`;

            html += `
              <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <div style="font-weight: 500; font-size: ${fontSize}; margin-bottom: 2px;">${dayName}</div>
                <img src="${iconPath}" style="width: ${iconSize}; height: ${iconSize}; margin: 2px 0;">
                <div style="font-size: ${tempSize}; font-weight: 600;">
                  ${day.temperature}° ${low}
                </div>
              </div>`;
        });
        html += '</div>';
        return html;

      } catch (e) {
        return `Error: ${e}`;
      }
    ]]]
